<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>YouTube Video Downloader</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.1/dist/darkly/bootstrap.min.css"
            rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.14.0/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.14.0/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.14.0/SplitText.min.js"></script>
</head>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js"></script>

<script>
    // Alle Tooltips aktivieren
    document.addEventListener("DOMContentLoaded", () => {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
    });
</script>
<body class="p-4">

<div class="container">
    <div class="image-container">
        <img src="{{ url_for('static', filename='logo/logo.png') }}" alt="Title" class="title-image">
    </div>
    <div class="button-row mb-4">
        <span data-bs-toggle="tooltip" title="Choose download folder">
    <a id="folder-button" href="{{ url_for('choose_download_folder_page') }}" class="btn icon-btn">
        <img src="{{ url_for('static', filename='icons/folder-open.svg') }}" alt="DownloadFolder">
    </a>
</span>
        <p><strong>{{ download_folder }} </strong> is used</p>
        <span data-bs-toggle="tooltip" title="Settings" id="settings-tooltip">
        <a id="settings-button" href="{{ url_for('settings_page') }}" class="btn icon-btn">
    <img src="{{ url_for('static', filename='icons/settings.svg') }}" alt="Settings">
</a>
        </span>
    </div>

    <!-- Grid für drei Spalten -->
    <div class="d-flex" style="gap:1rem; height: calc(100vh - 120px);">
        <!-- Linke Spalte -->
        <div class="d-flex flex-column equal-col">
            <!-- Download task list -->
            <div class="card now-downloading mb-3">
                <div class="card-header">
                    <h3>Now Downloading</h3>
                </div>
                <div class="card-body">
                    <div id="current-video">
                        <strong id="video-title"></strong>
                    </div>
                </div>
            </div>
            <div class="card" style="flex: 1;">
                <div class="card-header"><h3>Download Task List</h3></div>
                <div class="card-body" style="overflow-y:auto;">
                    <ul id="tasks" class="list-group mb-0"></ul>
                    <span id="moving-bullet"></span>
                </div>
            </div>

            <!-- Download Queue -->
            <div class="card queue-card" style="flex: 2;">
                <div class="card-header queue-header">
                    <h3>Download Queue</h3>
                </div>
                <div class="card-body">
                    <ul id="queue" class="queue-list mb-0"></ul>
                </div>
            </div>
        </div>

        <!-- Mittlere Spalte: Download Form -->
        <div class="equal-col">

            <div style="flex:1;">
                <form action="{{ url_for('video_settings', download_folder=download_folder) }}" method="POST"
                      class="mb-4 form-card">
                    <label class="form-label"><strong>YouTube Link</strong></label>
                    <input type="text" name="video_url" class="form-control mb-3" placeholder="Insert YouTube Link"
                           autocomplete="off">

                    <hr class="my-4">

                    <label class="form-label"><strong>Video Quality Settings</strong></label>
                    <select name="video_quality" class="form-select mb-3">
                        {% for quality in video_quality %}
                        <option value="{{ quality }}">{{ quality }}</option>
                        {% endfor %}

                        {% if checkbox %}
                        <option value="custom" selected>Custom</option>
                        {% else %}
                        <option value="custom">Custom</option>
                        {% endif %}
                    </select>

                    <span id="custom_video_resolution_container" style="display: none;">
                        <label class="form-label"><strong>Custom Video Resolution</strong></label>
                        <select name="video_resolution" class="form-select mb-2">
                            {% for resolution in video_resolution %}
                            <option value="{{ resolution }}">{{ resolution }}</option>
                            {% endfor %}
                        </select>
                    </span>

                    {% if video_checkbox %}
                    <input type="checkbox" name="video_checkbox" value="yes" class="form-check-input" id="videoCheckbox"
                           checked>
                    {% else %}
                    <input type="checkbox" name="video_checkbox" value="yes" class="form-check-input"
                           id="videoCheckbox">
                    {% endif %}
                    <label for="videoCheckbox" class="form-check-label">Download Video</label>

                    {% if audio_checkbox %}
                    <input type="checkbox" name="audio_checkbox" value="yes" class="form-check-input" id="audioCheckbox"
                           checked>
                    {% else %}
                    <input type="checkbox" name="audio_checkbox" value="yes" class="form-check-input"
                           id="audioCheckbox">
                    {% endif %}
                    <label for="audioCheckbox" class="form-check-label">Download Audio</label>

                    <!-- <hr class="my-4">

                    <label class="form-label"><strong>Custom Video Resolution</strong></label>
                    <select name="video_resolution" class="form-select mb-2">
                        {% for resolution in video_resolution %}
                        <option value="{{ resolution }}">{{ resolution }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-check mb-3">
                        {% if checkbox %}
                        <input type="checkbox" name="custom_resolution" value="yes" class="form-check-input"
                               id="customRes"
                               checked>
                        {% else %}
                        <input type="checkbox" name="custom_resolution" value="yes" class="form-check-input"
                               id="customRes">
                        {% endif %}
                        <label for="customRes" class="form-check-label">Use custom resolution</label>
                    </div> -->

                    <hr class="my-4">

                    <label class="form-label"><strong>Video Container</strong></label>
                    <select name="video_container" class="form-select mb-4">
                        {% for container in video_container %}
                        <option value="{{ container }}">{{ container }}</option>
                        {% endfor %}
                    </select>

                    <hr class="my-4">
                    <input type="submit" class="btn btn-info w-100 btn-download" value="Start Download">
                </form>

            </div>

            <a id="cancel-download" href="{{ url_for('abort') }}" class="btn btn-gradient mb-4" style="display: none;">
                Pause Download
            </a>
            {% if abort %}
<div class="d-flex gap-2 mb-4">
    <a href="{{ url_for('cancel_download') }}" class="btn btn-gradient flex-fill">
        Cancel Download
    </a>
    <a href="{{ url_for('resume_download') }}" class="btn btn-gradient flex-fill">
        Resume Download
    </a>

</div>
{% endif %}

        </div>

        <!-- Rechte Spalte: Konsole -->
        <div class="d-flex flex-column equal-col">
            <div class="card flex-fill">
                <div class="card-header"><h3>Console</h3></div>
                <div class="card-body console-box" style="overflow-y:auto;">
                    <div class="console" id="console"></div>
                </div>
            </div>

            <div class="loading-container console-progress">
                <div class="loading-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">0%</div>
            </div>
        </div>
    </div>
</div>
<script>
    var socket = io();
    // var cancelLink = document.getElementById('cancel-download');

// Progress
socket.on('progress', function (data) {
if (data.message) {
    document.getElementById('progress-text').textContent = data.message;
    return;
}

let percent = parseFloat(data.percent);
const fill = document.getElementById("progress-fill");
const text = document.getElementById("progress-text");

fill.style.width = percent + "%";
text.textContent = `Progress: ${data.percent} | Speed: ${data.speed} | ETA: ${data.eta}`;
});

// Cancel button
// Elemente laden
const startDownloadBtn = document.querySelector('.btn-download');
const cancelLink = document.getElementById('cancel-download');
const folderButton = document.getElementById('folder-button');
const settingsButton = document.getElementById('settings-button');

function refreshTooltips() {
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
        // bestehende Instanz löschen
        if (bootstrap.Tooltip.getInstance(el)) {
            bootstrap.Tooltip.getInstance(el).dispose();
        }
        // Tooltip neu aktivieren
        new bootstrap.Tooltip(el);
    });
}

// Funktion, die den UI-Status für laufende Downloads setzt
function updateDownloadUI(isDownloading) {
    if (isDownloading) {
        startDownloadBtn.value = "Add video to queue";

        folderButton.classList.add('disabled');
        folderButton.style.opacity = "0.5";
        folderButton.style.cursor = "not-allowed";
        folderButton.parentElement.setAttribute("data-bs-title", "Not available during download.");

        settingsButton.classList.add('disabled');
        settingsButton.style.opacity = "0.5";
        settingsButton.style.cursor = "not-allowed";
        settingsButton.parentElement.setAttribute("data-bs-title", "Not available during download.");
    } else {
        startDownloadBtn.value = "Start Download";

        folderButton.classList.remove('disabled');
        folderButton.style.opacity = "1";
        folderButton.style.cursor = "pointer";
        folderButton.title = "Choose download folder";
        folderButton.parentElement.setAttribute("data-bs-title", "Choose download folder");

        settingsButton.classList.remove('disabled');
        settingsButton.style.opacity = "1";
        settingsButton.style.cursor = "pointer";
        settingsButton.parentElement.setAttribute("data-bs-title", "Settings");
    }

    refreshTooltips();
}



// Socket-Event anpassen, das Cancel-Button anzeigt/versteckt
socket.on("cancel", function(state) {
    if (state === true) {
        cancelLink.style.display = "inline-block";
        updateDownloadUI(true);
    } else {
        cancelLink.style.display = "none";
        updateDownloadUI(false);
    }
});

// Falls Cancel/Resume Buttons (nach Abbruch) über Template kommen, überwache sie auch

const checkCancelResumeButtons = () => {
    const cancelBtn = document.querySelector('a[href="{{ url_for('cancel_download') }}"]');
    const resumeBtn = document.querySelector('a[href="{{ url_for('resume_download') }}"]');

    const anyVisible = (cancelBtn && cancelBtn.offsetParent !== null) ||
                       (resumeBtn && resumeBtn.offsetParent !== null);

    updateDownloadUI(anyVisible);
}

// Beobachte DOM-Änderungen in dem Bereich, wo Cancel/Resume Buttons sind

const buttonsContainer = document.querySelector('.d-flex.gap-2.mb-4');
if (buttonsContainer) {
    const observer = new MutationObserver(() => {
        checkCancelResumeButtons();
    });
    observer.observe(buttonsContainer, { childList: true, subtree: true });
    checkCancelResumeButtons(); // Initial aufrufen
}

    // Console
const consoleBox = document.getElementById("console");

const createMessage = (msg) => {
    if (Array.isArray(msg)) {
        msg.forEach(entry => addLine(entry));
    } else {
        addLine(msg);
    }
};

function addLine(data) {
    let timeStamp, message;

    // Wenn es ein Objekt ist (vom Python-emit)
    if (typeof data === "object" && data !== null) {
        timeStamp = data.time_stamp;
        message = data.message;
    } else {
        // Fallback (alte Daten ohne Zeitstempel)
        timeStamp = "";
        message = data;
    }

    const content = `
        <div class="text" title="${timeStamp}">
            <span>
                <strong class="console-text">[console]</strong>: ${message}
            </span>
        </div>
    `;
    consoleBox.innerHTML += content;

    // Autoscroll
    const consoleContainer = consoleBox.parentElement;
    consoleContainer.scrollTop = consoleContainer.scrollHeight;
}

socket.on("console", (msg) => {
    createMessage(msg);
});




    // Queue
    socket.on("queue", function(queue) {
let list = document.getElementById("queue");
list.innerHTML = "";
queue.forEach(videoName => {
    let li = document.createElement("li");

    // SVG Element erzeugen
    let svg = `
        <svg class="queue-icon" xmlns="http://www.w3.org/2000/svg"
             viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
            <path d="M2.5 17a24.12 24.12 0 0 1 0-10
                     2 2 0 0 1 1.4-1.4
                     49.56 49.56 0 0 1 16.2 0
                     A2 2 0 0 1 21.5 7
                     a24.12 24.12 0 0 1 0 10
                     2 2 0 0 1-1.4 1.4
                     49.55 49.55 0 0 1-16.2 0
                     A2 2 0 0 1 2.5 17"/>
            <path d="m10 15 5-3-5-3z"/>
        </svg>
    `;

    li.innerHTML = svg + videoName;
    list.appendChild(li);
});
});


    //mp3
    document.addEventListener("DOMContentLoaded", () => {
        const audioCheckbox = document.getElementById("audioCheckbox");
        const videoCheckbox = document.getElementById("videoCheckbox");
        const containerSelect = document.querySelector("select[name='video_container']");
        const videoQualitySelect = document.querySelector('select[name="video_quality"]');

        const form = document.querySelector('form');

        const mp3Option = document.createElement("option");
        mp3Option.value = "mp3";
        mp3Option.textContent = "mp3";

        function updateContainers() {
            if (audioCheckbox.checked && !videoCheckbox.checked) {
                // mp3 hinzufügen, falls nicht schon drin
                if (![...containerSelect.options].some(opt => opt.value === "mp3")) {
                    containerSelect.appendChild(mp3Option);
                }
            } else {
                // mp3 entfernen
                [...containerSelect.options].forEach(opt => {
                    if (opt.value === "mp3") opt.remove();
                });
            }
        }

        function checkCustomQuality(selectedQuality) {
        if (selectedQuality == "custom") {
            document.getElementById("custom_video_resolution_container").style.display = "inline";
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'custom_resolution';
            hiddenInput.value = 'yes';
            hiddenInput.id = 'custom_resolution';

            form.appendChild(hiddenInput);

        } else {
            document.getElementById("custom_video_resolution_container").style.display = "none";
            const element = document.getElementById('custom_resolution');
            if (element) {
                element.remove();
            }
        }
    }

        // Initial check
        updateContainers();
        checkCustomQuality(videoQualitySelect.value);
        // Initialer Status
updateDownloadUI(cancelLink.style.display === "inline-block");

        // Event Listener
        audioCheckbox.addEventListener("change", updateContainers);
        videoCheckbox.addEventListener("change", updateContainers);

        // Listen to changes of the video quality select box
        videoQualitySelect.addEventListener('change', (event) => {
            checkCustomQuality(event.target.value);
        });
    });

    // Task list
    //var socket = io();

    var movingBullet = document.getElementById("moving-bullet");
    var lastWorkingIndex = -1;

    socket.on("update_tasks", function(tasks) {
        let list = document.getElementById("tasks");
        list.innerHTML = "";

        let workingIndex = -1;

        tasks.forEach((task, index) => {
            let li = document.createElement("li");
            li.className = "list-group-item";
            li.textContent = task.name;
            li.style.color = task.status === "done" ? "green" : "white";
            if (task.status === "done") li.style.textDecoration = "line-through";

            list.appendChild(li);

            if (task.status === "working") workingIndex = index;
        });

        if (workingIndex !== -1) {
            let li = list.children[workingIndex];
            let bulletOffsetX = 8;
            let bulletOffsetY = (li.offsetHeight - 12) / 2;

            // Bullet sichtbar machen
            movingBullet.style.opacity = 1;
            movingBullet.style.left = bulletOffsetX + "px";
            movingBullet.style.top = (li.offsetTop + bulletOffsetY) + "px";

            // Bounce nur starten, wenn Task wechselt
            if (workingIndex !== lastWorkingIndex) {
                movingBullet.classList.remove("bounce");
                void movingBullet.offsetWidth; // Force reflow
                movingBullet.classList.add("bounce");
            }

            lastWorkingIndex = workingIndex;
        } else {
            // Bullet sanft verschwinden lassen
            movingBullet.style.opacity = 0;
            movingBullet.classList.remove("bounce");
            lastWorkingIndex = -1;
        }
    });

    // current video
    socket.on("current_video", function(data) {
const titleEl = document.getElementById("video-title");

titleEl.textContent = data;
});
</script>
</body>
</html>
